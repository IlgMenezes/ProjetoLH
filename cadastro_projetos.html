<!DOCTYPE html>
<html>
<head>
    <title>Cadastro de Centro de Custo</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/css/bootstrap-datepicker3.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="icon" href="https://simatec.com.br/wp-content/uploads/2017/03/cropped-logotipo_Horizontal_Poli-32x32.png" sizes="32x32">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="js/error-logger.js" defer></script>
</head>
<body>
		<div id="menu-placeholder"></div>
    <div class="container">
        <form class="recuo_form row">
            <div class="col-sm-4">
                <div class="mb-3 row">
                    <label for="nome" class="form-label col-sm-4">Centro de Custo:</label>
                    <div class="col-sm-8">
                        <input type="text" id="nomeProjeto" name="nomeProjeto" maxlength="68" class="form-control" required>
                    </div>
                </div>
				<div class="mb-3 row">
                    <label for="cliente" class="form-label col-sm-4">Cliente:</label>
                    <div class="col-sm-8">
                        <input type="text" id="nomeCliente" name="nomeCliente" class="form-control" required>
                    </div>
                </div>				
				<div class="mb-3 row">
                    <label for="gestor" class="form-label col-sm-4">Gestor:</label>
                    <div class="col-sm-8">
                       <select id="listaGestor" name="listaGestor" class="form-select" required>
							<option value="1">Karina Marinho de Paz</option>
							<option value="2">Simon Everton Lira Filho</option>
							<option value="3">Salomé Christie Benites de Angola</option>
							<option value="4">Evandro Aurélio Brito Flores</option>
							<option value="5">Manuela Taís de Faria</option>
							<option value="6">Luciano Ezequiel Esteves Neto</option>
						</select>
                    </div>
                </div>
				<div class="mb-3 row">
                    <label for="unidade" class="form-label col-sm-4">Unidade:</label>
                    <div class="col-sm-8">
                        <input type="text" id="nomeUnidade" name="nomeUnidade" class="form-control" required>
                    </div>
                </div>
				<div class="mb-3 row">
                    <label for="statusSituacao" class="form-label col-sm-4">Situação:</label>
                    <div class="col-sm-8">
                       <select id="statusSituacao" name="statusSituacao" class="form-select" required>
							<option value="1">Em Andamento</option>
							<option value="2">Finalizado</option>
						</select>
                    </div>
                </div>
                <div class="mb-3 row">
                    <label for="dataInicio" class="form-label col-sm-4">Data Início:</label>
                    <div class="col-sm-8">
                        <div class="input-group">
                            <input type="text" id="dataInicio" name="dataInicio" class="form-control" placeholder="DD/MM/AAAA" required>
                            <button class="btn btn-outline-secondary" type="button" id="calendario"><i class="bi bi-calendar"></i></button>
                        </div>
                    </div>
                </div>
				<div class="mb-3 row">
                    <label for="dataFim" class="form-label col-sm-4">Data Fim:</label>
                    <div class="col-sm-8">
                        <div class="input-group">
                            <input type="text" id="dataFim" name="dataFim" class="form-control" placeholder="DD/MM/AAAA" required>
                            <button class="btn btn-outline-secondary" type="button" id="calendario"><i class="bi bi-calendar"></i></button>
                        </div>
                    </div>
                </div>
								<div class="mb-3 row">
                    <label for="observacao" class="form-label col-sm-4">Observação:</label>
                    <div class="col-sm-8">
                        <input type="text" id="descricaoObservacao" name="descricaoObservacao" class="form-control">
                    </div>
                </div>
            </div>
            <div id="CadastroEquipes" class="col-sm-8">
				<form id="formEquipe">
					<div class="mb-3 row">
						<label for="assuntos" class="form-label col-sm-2">Palavras-chave:</label>
						<div class="col-sm-6">
							<div class="input-group">
								<input type="text" id="assuntoInput" class="form-control" placeholder="Digite uma palavra-chave do projeto">
								<button class="btn btn-outline-secondary" type="button" id="btnAdicionarAssunto">
										<i class="fa fa-plus"></i>
								</button>
							</div>
							<div id="assuntosContainer" class="mt-2">
								<!-- Os assuntos serão exibidos aqui como tags -->
							</div>
						</div>
					</div>
					<div class="mb-3 row">
						<label for="equipe" class="form-label col-sm-2">Equipe:</label>
						<div class="col-sm-6">
							<select id="equipe" name="equipe" class="form-select" multiple required>
								<option value="1">Karina Marinho de Paz</option>
								<option value="2">Simon Everton Lira Filho</option>
								<option value="3">Salomé Christie Benites de Angola</option>
								<option value="1">Evandro Aurélio Brito Flores</option>
								<option value="2">Manuela Taís de Faria</option>
								<option value="3">Luciano Ezequiel Esteves Neto</option>
								<!-- Outras opções de equipe -->
							</select>
						</div>
					</div>
					<div class="mb-3 row">
						<label for="controleVSB" class="form-label col-sm-2">Controle VSB:</label>
						<div class="col-sm-8">
								<label class="switch">
										<input type="checkbox" id="controleVSB" name="controleVSB">
										<span class="slider round"></span>
								</label>
						</div>
					</div>
				</form>
				<form id="formAtividades">
					<div class="mb-3 row">
						<label for="setor" class="form-label col-sm-2">Setor:</label>
						<div class="col-sm-6">
						   <select id="setor" name="setor" class="form-select">
								<option value="1">Comercial</option>
								<option value="2">Projetos</option>
								<option value="3">Tecnologia</option>
								<option value="4">Diretoria</option>
								<option value="5">Contratos</option>
								<option value="6">Orçamento</option>
								<option value="7">Almoxarifado</option>
								<option value="8">Administrativo</option>
								<option value="9">Vendas</option>
								<option value="10">Compras</option>
								<option value="11">Financeiro</option>
								<option value="12">Oficina</option>
							</select>
						</div>
					</div>
					<div class="mb-3 row">
						<label for="atividade" class="form-label col-sm-2">Atividade:</label>
						<div class="col-sm-6">
							 <select id="atividade" name="atividade" class="form-select">
							 <!-- Opções de atividades serão carregadas dinamicamente no backend -->
							 <option value="1">Comercial</option>
								<option value="2">Projetos</option>
								<option value="3">Tecnologia</option>
							</select>
						</div>
					</div>
					<div class="mb-3 row">
						<div class="col-sm-4"></div>
						<div class="col-sm-8">
							<button type="button" class="btn btn-primary" onclick="adicionarAtividade()">Adicionar Atividade</button>
						</div>
					</div>
					<div class="table-wrapper">
						<table id="tabelaAtividades" class="table" style="display: none; border: 1px solid #ccc;">
							<colgroup>
								<col style="width: 15%;">
								<col style="width: 25%;">
								<col style="width: 10%;">
								<col style="width: 10%;">
								<col style="width: 10%;">
								<col style="width: 10%;">
								<col style="width: 10%;">
								<col style="width: 10%;">
							</colgroup>
							<thead>
								<tr class="titulo-colunas">
									<th>Setor</th>
									<th>Atividade</th>
									<th>Horas A</th>
									<th>Horas B</th>
									<th>Horas C</th>
									<th>Horas D</th>
									<th>Horas E</th>
									<th>Horas F</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</form>
			</div>
             <div class="row">
                <div class="col-sm-10">
					<button type="button" id="btnSalvar" class="btn btn-primary" onclick="salvarCentroCusto()">Salvar</button>
                    <button type="button" class="btn btn-primary" onclick="voltarParaListagem()">Voltar</button>
                </div>
            </div>
        </form>
    </div>
	<div id="modalCarregamento" class="modal">
	  <div class="modal-content">
		<h2>Aguarde...</h2>
		<p>Processando sua solicitação.</p>
	  </div>
	</div>

    <style>
        .recuo_form {
            padding: 50px 0 0 0;
        }
        .recuo_horarios {
            padding: 2% 30% 5% 10%;
			width: 100%;
        }
        .label_horarios {
            font-size: 12px;
            font-weight: bold;
			margin-bottom: 0;
        }
        .center {
          text-align: center;
        }
        .recuo_textareas {
            margin-left: 20px;
        }
		.wrapper {
		  display: grid;
		  grid-template-columns: 1fr 3fr;
		  grid-gap: 20px; /* Espaçamento entre as colunas */
		}

		.titulo-colunas {
				background-color: #f2f2f2 !important;
		}
		
		#tabelaAtividades input[type="number"],
		#tabelaAtividades input[type="text"],
		#tabelaAtividades select {
			font-size: 0.9em; /* Redução do tamanho da fonte nas caixas de texto */
			padding: 0.25em; /* Ajuste o preenchimento para manter a estética */
		}
		
		#tabelaAtividades thead tr {
			background-color: #f2f2f2;
		}
		
		#tabelaAtividades {
			width: 100%; /* Largura total do contêiner */
			font-size: 0.8em; /* Redução do tamanho da fonte */
		}
		
		#tabelaAtividades th, #tabelaAtividades td {
			padding: 0.5em; /* Ajuste no espaçamento interno para células */
		}

		#tabelaAtividades .btn {
			padding: 0.25em 0.5em;
			font-size: 0.7em; /* Tamanho menor para botões */
		}
		
		.col {
			margin-bottom: 10px;
			margin-right: 10px; /* Use a variável --distancia-campos para controlar a distância */
		}
		
		.input-container {
			display: flex;
			flex-direction: column;
			align-items: center;
		}
		
		.table-wrapper {
			overflow-y: auto; /* Mantém a rolagem vertical */
			overflow-x: auto; /* Permite rolagem horizontal se necessário */
			max-width: 100%; /* Ajusta para a largura máxima */
			max-height: 300px; /* Ajuste a altura conforme necessário */
		}
		.required-field {
			border: 1px solid red;
			background-color: #ffe6e6;
		}
		.modal {
		  display: none; /* Escondido por padrão */
		  position: fixed; /* Ficará fixo na tela */
		  z-index: 1; /* Ficará no topo */
		  left: 0;
		  top: 0;
		  width: 100%; /* Largura total */
		  height: 100%; /* Altura total */
		  overflow: auto; /* Habilitar a rolagem se necessário */
		  background-color: rgb(0,0,0); /* Cor de fundo */
		  background-color: rgba(0,0,0,0.4); /* Cor de fundo com opacidade */
		}

		/* Estilo do conteúdo do modal */
		.modal-content {
		  background-color: #fefefe;
		  margin: 15% auto; /* 15% do topo e centralizado horizontalmente */
		  padding: 20px;
		  border: 1px solid #888;
		  width: 35%; /* Pode ser mais ou menos, dependendo do desejado */
		  text-align: center;
		}

		/* Opcional: Estilos para animação do modal */
		@keyframes fadeIn {
		  from {opacity: 0;}
		  to {opacity: 1;}
		}

		@keyframes fadeOut {
		  from {opacity: 1;}
		  to {opacity: 0;}
		}

		.modal.show {
		  display: block; /* Mostrar o modal */
		  animation: fadeIn 1s;
		}

		.modal.hide {
		  animation: fadeOut 1s;
		  animation-fill-mode: forwards; /* Mantém o estado final depois da animação */
		}
		.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #2196F3;
}

input:focus + .slider {
    box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

        .ui-autocomplete {
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
        }
        .assunto-tag {
            display: inline-block;
            background-color: #e9ecef;
            border-radius: 4px;
            padding: 5px 10px;
            margin: 3px;
            font-size: 14px;
            cursor: default;
        }
        .assunto-tag .remove-assunto {
            margin-left: 5px;
            cursor: pointer;
            color: #dc3545;
        }
        .assunto-tag .remove-assunto:hover {
            color: #bd2130;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/locales/bootstrap-datepicker.pt-BR.min.js"></script>
    <script src="menu/menu.js"></script>
    <script src="js/custom-ajax.js"></script>
    <script>
		var idCentroDeCusto
		var todasAtividades = [];
		var todosUsuarios = [];
		var todosSetores = [];
		var urlParams = new URLSearchParams(window.location.search);
		var token = urlParams.get('token');
		var baseUrl;
		var assuntosExistentes = []; // Lista de assuntos já cadastrados no sistema
		var assuntosProjeto = []; // Lista de assuntos do projeto atual (objetos com id e descricao)
        $(document).ready(function() {
			if (window.location.hostname === "localhost") {
				baseUrl = "https://localhost:44349/";
			} else {
				baseUrl = "https://sghapi20230704112902.azurewebsites.net/";
			}
			
			if(validateToken()){
				$('#nomeUsuario').text(localStorage.getItem('uname'));
				$("input[name^='data']").datepicker({
					format: 'dd/mm/yyyy',
					todayBtn: 'linked',
					todayHighlight: true,
					autoclose: true,
					language: 'pt-BR'
				}).on('show', function(e){
					e.preventDefault();
					e.stopPropagation();
				});

				$('#calendario').on('click', function() {
					$("#dataInicio").datepicker('show');
				});
				
				$('#equipe').select2();
				 
				idCentroDeCusto = urlParams.get('idCentroDeCusto');
				carregarOpcoesSelect(idCentroDeCusto);
				limparFormulario();
				filtrarAtividades();
			 }
        });
		
		function carregarOpcoesSelect(idCentroDeCusto) {
			$.ajax({
				url: baseUrl + 'api/CentroDeCusto/GetCentroDeCustosViewModel',
				type: 'GET',
				data: { idCentroDeCusto: idCentroDeCusto },
				success: function(data) {
					var gestorOptions = '<option value="-1" disabled selected>Selecione...</option>';
					data.gerentes.forEach(function(usuario) {
						gestorOptions += '<option value="' + usuario.id + '">' + usuario.nome + '</option>';
					});
					$('#listaGestor').html(gestorOptions);

					var equipeOptions = '';
					data.usuarios.forEach(function(usuario) {
						equipeOptions += '<option value="' + usuario.id + '">' + usuario.nome + '</option>';
					});
					$('#equipe').html(equipeOptions);

					var setorOptions = '<option value="-1" disabled selected>Selecione...</option>';
					data.setores.forEach(function(setor) {
						setorOptions += '<option value="' + setor.id + '">' + setor.nome + '</option>';
					});
					$('#setor').html(setorOptions);

					var atividadeOptions = '<option value="-1" disabled selected>Selecione...</option>';
					data.atividades.forEach(function(atividade) {
						atividadeOptions += '<option value="' + atividade.id + '">' + atividade.nome + '</option>';
					});
					$('#atividade').html(atividadeOptions);
					
					todasAtividades = data.atividades;
					todosUsuarios = data.usuarios;
					todosSetores = data.setores;
					
					if (data.centroDeCusto) {
						preencherFormularioComDadosDeEdicao(data.centroDeCusto);
					}
					
					// Carregar assuntos do projeto se estiver editando
					if (data.centroDeCusto && data.centroDeCusto.assuntos) {
						assuntosProjeto = data.centroDeCusto.assuntos;
						assuntosProjeto.forEach(function(assunto) {
							var tagHtml = '<span class="assunto-tag" data-assunto-id="' + assunto.id + '">' + 
								assunto.descricao + 
								'<span class="remove-assunto" data-assunto-id="' + assunto.id + '"><i class="fa fa-times"></i></span>' +
								'</span>';
							
							$("#assuntosContainer").append(tagHtml);
						});
						
						// Adicionar evento para remover o assunto
						$(".remove-assunto").off("click").on("click", function() {
							var assuntoId = $(this).data("assunto-id");
							removerAssunto(assuntoId);
						});
					}
					
					// Configurar autocomplete de assuntos usando os dados já carregados
					if (data.assuntos) {
						assuntosExistentes = data.assuntos;
						configurarAutocompleteAssuntos();
					}
				},
				error: function(xhr, status, error) {
					// Tratar erros da chamada AJAX
					console.error("Erro ao carregar dados: " + error);
					alert("Erro ao carregar os dados. Por favor, tente novamente.");
				}
			});
		}
		
		function preencherFormularioComDadosDeEdicao(centroDeCusto) {
			// Preencher campos de texto simples
			$('#nomeProjeto').val(centroDeCusto.nomeCentroDeCusto);
			$('#nomeCliente').val(centroDeCusto.cliente);
			$('#nomeUnidade').val(centroDeCusto.unidade);
			$('#descricaoObservacao').val(centroDeCusto.observacao);
			document.getElementById("controleVSB").checked = centroDeCusto.controleVSB;

			// Selecionar opções em dropdowns
			$('#listaGestor').val(centroDeCusto.idGestor).trigger('change');
			$('#statusSituacao').val(centroDeCusto.situacao).trigger('change');

			// Configurar datas
			$('#dataInicio').datepicker('update', new Date(centroDeCusto.dataInicio));
			$('#dataFim').datepicker('update', new Date(centroDeCusto.dataFim));

			// Preencher seleções múltiplas (como equipes)
			var equipeIds = centroDeCusto.equipe.map(membro => membro.id);
			$('#equipe').val(equipeIds).trigger('change');

			// Preencher tabela de atividades, se aplicável
			preencherTabelaAtividades(centroDeCusto.atividades);
		}

		function preencherTabelaAtividades(atividades) {
			var tbody = $('#tabelaAtividades tbody');
			tbody.empty(); // Limpar quaisquer linhas existentes

			atividades.forEach(function(atividade) {
				var linha = $('<tr>');

				var setor = todosSetores.find(function(s) { return s.id === atividade.idSetor; });
				// Coluna para Setor
				linha.append($('<td>').html('<span class="valorSetor" style="display: none;">' + atividade.idSetor + '</span>' + (setor ? setor.nome : '')));

				// Coluna para Atividade
				linha.append($('<td>').html('<span class="valorAtividade" style="display: none;">' + atividade.id + '</span>' + atividade.nome));

				// Colunas para Horas (A, B, C, D, E, F)
				linha.append($('<td>').append($('<input>').attr({type: 'number', value: atividade.horasA, class: 'form-control', id: 'horaa'})));
				linha.append($('<td>').append($('<input>').attr({type: 'number', value: atividade.horasB, class: 'form-control', id: 'horab'})));
				linha.append($('<td>').append($('<input>').attr({type: 'number', value: atividade.horasC, class: 'form-control', id: 'horac'})));
				linha.append($('<td>').append($('<input>').attr({type: 'number', value: atividade.horasD, class: 'form-control', id: 'horad'})));
				linha.append($('<td>').append($('<input>').attr({type: 'number', value: atividade.horasE, class: 'form-control', id: 'horae'})));
				linha.append($('<td>').append($('<input>').attr({type: 'number', value: atividade.horasF, class: 'form-control', id: 'horaf'})));
				linha.append($('<td>').append($('<button>').attr({type: 'button', class: 'btn btn-danger btn-sm'}).text('X').click(function() {
					excluirAtividade(this);
				})));

				tbody.append(linha);
			});

			// Mostrar a tabela se houver atividades
			if (atividades.length > 0) {
				$('#tabelaAtividades').show();
			} else {
				$('#tabelaAtividades').hide();
			}
		}


		
		function filtrarAtividades(){
			// Filtrar as atividades com base no setor selecionado
			var selectSetor = $("#setor");

			// Adicione o ouvinte de eventos ao select de Setor
			selectSetor.on("change", function() {
				var setorSelecionado = parseInt($(this).val());

				// Filtrar as atividades pelo setor selecionado
				var atividadesFiltradas = todasAtividades.filter(function(atividade) {
					return atividade.idSetor == setorSelecionado;
				});

				// Popule o select de Atividade com as atividades filtradas
				var selectAtividade = $("#atividade");
				selectAtividade.empty(); // Limpa as opções existentes
				
				selectAtividade.append(new Option("Selecione...", "-1"));
				atividadesFiltradas.forEach(function(atividade) {
					selectAtividade.append(new Option(atividade.nome, atividade.id));
				});
			});
		}
		
		function adicionarAtividade() {
			var vSetor = document.getElementById("setor").value;
			var vAtividade = document.getElementById("atividade").value;
			
			if (vSetor === "-1" || vAtividade === "-1") {
				alert("Por favor, selecione um Setor e uma Atividade válidos.");
				return;
			}
			
			var desSetor = $("#setor option:selected").text();;
			var desAtividade = $("#atividade option:selected").text();;
			
			var tabela = document.getElementById("tabelaAtividades");
			var tbody = tabela.getElementsByTagName("tbody")[0];
			tabela.style.display = "table";
			
			var linha = tbody.insertRow();
			linha.insertCell().innerHTML = '<span class="valorSetor" style="display: none;">' + vSetor + '</span>' + desSetor;
			linha.insertCell().innerHTML = '<span class="valorAtividade" style="display: none;">' + vAtividade + '</span>' + desAtividade;
			linha.insertCell().innerHTML = '<input id="horaa" type="number" class="form-control">';
			linha.insertCell().innerHTML = '<input id="horab" type="number" class="form-control">';
			linha.insertCell().innerHTML = '<input id="horac" type="number" class="form-control">';
			linha.insertCell().innerHTML = '<input id="horad" type="number" class="form-control">';
			linha.insertCell().innerHTML = '<input id="horae" type="number" class="form-control">';
			linha.insertCell().innerHTML = '<input id="horaf" type="number" class="form-control">';
			var $linha = $(linha);
			$linha.append($('<td>').append($('<button>').attr({type: 'button', class: 'btn btn-danger btn-sm'}).text('X').click(function() {
				excluirAtividade(this);
			})));
			
			// Remover a opção selecionada do campo de atividade
			$("#atividade option[value='" + vAtividade + "']").remove();
			$("#atividade").trigger('change'); 
		}
		
		function salvarCentroCusto() {
			// Obtenha os valores do formulário
			var nomeProjeto = document.getElementById("nomeProjeto").value;
			var nomeCliente = document.getElementById("nomeCliente").value;
			var listaGestor = document.getElementById("listaGestor").value;
			var nomeUnidade = document.getElementById("nomeUnidade").value;
			var situacao = document.getElementById("statusSituacao").value;
			var dataInicio = document.getElementById("dataInicio").value;
			var dataFim = document.getElementById("dataFim").value;
			var controleVSB = document.getElementById("controleVSB").checked;

			if(!formularioValido()){
				alert("Informações inválidas!");
				return;
			}
			
			const modalCarregamento = document.getElementById('modalCarregamento');
			modalCarregamento.classList.add('show');
			
			var descricaoObservacao = document.getElementById("descricaoObservacao").value;
			var equipeSelecionada = obterUsuariosSelecionados();
			var atividades = obterAtividadesSelecionadas();
			
			// Montar o objeto de dados
			var centroCusto = {
				nomeCentroDeCusto: nomeProjeto,
				cliente: nomeCliente,
				idGestor: parseInt(listaGestor), // Certifique-se de converter para inteiro
				unidade: nomeUnidade,
				situacao: parseInt(situacao), // Certifique-se de converter para inteiro
				dataInicio: formatDate(dataInicio), // Converta a data para o formato correto
				dataFim: formatDate(dataFim), // Converta a data para o formato correto
				observacao: descricaoObservacao,
				controleVSB: controleVSB,
				atividades: atividades,
				equipe: equipeSelecionada,
				assuntos: assuntosProjeto // Incluir os assuntos como parte do objeto centroCusto
			};
			
			if (idCentroDeCusto !== undefined && idCentroDeCusto !== null && idCentroDeCusto !== "0") {
				centroCusto.id = parseInt(idCentroDeCusto);
			}
			
			// Enviar os dados para o backend
			enviarDadosParaBackend(centroCusto);
		}
		
		function obterAtividadesSelecionadas() {
			var atividades = [];

			$('#tabelaAtividades tr').slice(1).each(function () {
				var setorId = $(this).find('.valorSetor').text();
				var atividadeId = $(this).find('.valorAtividade').text();
				var horasA = $(this).find('#horaa').val();
				var horasB = $(this).find('#horab').val();
				var horasC = $(this).find('#horac').val();
				var horasD = $(this).find('#horad').val();
				var horasE = $(this).find('#horae').val();
				var horasF = $(this).find('#horaf').val();

				var atividadeObj = {
					idSetor: parseInt(setorId),
					id: parseInt(atividadeId),
					horasA: horasA === "" ? null : parseFloat(horasA),
					horasB: horasB === "" ? null : parseFloat(horasB),
					horasC: horasC === "" ? null : parseFloat(horasC),
					horasD: horasD === "" ? null : parseFloat(horasD),
					horasE: horasE === "" ? null : parseFloat(horasE),
					horasF: horasF === "" ? null : parseFloat(horasF) 
				};

				atividades.push(atividadeObj);
			});

			return atividades;
		}
		
		function obterUsuariosSelecionados() {
			var usuariosSelecionados = [];
			var idsUsuariosSelecionados = $('#equipe').val(); // IDs dos usuários selecionados na equipe
			
			usuariosSelecionados = todosUsuarios.filter(function(usuario) {
				return idsUsuariosSelecionados.includes(usuario.id.toString());
			});
			
			return usuariosSelecionados;
		}

		function enviarDadosParaBackend(centroCusto) {
			// Enviar uma solicitação HTTP POST para o backend
			fetch(baseUrl + 'api/CentroDeCusto', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(centroCusto)
			})
			.then(response => response.json())
			.then(data => {
				// Tratar a resposta do backend, se necessário
				console.log(data);
				// Redirecionar ou exibir uma mensagem de sucesso, por exemplo
				alert('Centro de Custo salvo com sucesso!');
				limparFormulario();
				window.location.href = "./listagem_projetos.html";
			})
			.catch(error => {
				// Tratar erros de requisição ou do backend, se necessário
				console.error(error);
				// Exibir uma mensagem de erro, por exemplo
				alert('Ocorreu um erro ao salvar o Centro de Custo. Por favor, tente novamente mais tarde.');
				const modalCarregamento = document.getElementById('modalCarregamento');
				modalCarregamento.classList.remove('show');
			});
		}
		
		function excluirAtividade(button) {
			// Remover a linha da tabela
			$(button).closest('tr').remove();
			
			// Se não houver mais linhas, oculte a tabela
			if ($('#tabelaAtividades tbody tr').length === 0) {
				$('#tabelaAtividades').hide();
			}
		}
		
		function limparFormulario() {
			document.getElementById("nomeProjeto").value = "";
			document.getElementById("nomeCliente").value = "";
			document.getElementById("listaGestor").value = "";
			document.getElementById("nomeUnidade").value = "";
			document.getElementById("statusSituacao").value = "";
			document.getElementById("dataInicio").value = "";
			document.getElementById("dataFim").value = "";
			document.getElementById("descricaoObservacao").value = "";
			
			$("#setor").prop('selectedIndex', -1);
			$("#atividade").prop('selectedIndex', -1);
			$("#centrodecusto").prop('selectedIndex', -1);
			$("#tipoDespesa").prop('selectedIndex', -1);

			// Limpar a equipe selecionada
			$('#equipe').val(null).trigger('change');

			// Limpar a tabela de atividades
			var tabelaAtividades = document.getElementById("tabelaAtividades");
			var tbody = tabelaAtividades.querySelector("tbody");
			tbody.innerHTML = "";

			tabelaAtividades.style.display = "none";
			
			const modalCarregamento = document.getElementById('modalCarregamento');
			modalCarregamento.classList.remove('show');
			
			$('#tabelaAtividades tbody').empty();
			$('#tabelaAtividades').hide();
			$('#assuntosContainer').empty();
			assuntosProjeto = [];
		}
		
		function formatDate(dateStr) {
			// Verifica se a data não é vazia ou nula
			if (!dateStr) return "";
			var dia  = dateStr.split("/")[0];
			var mes  = dateStr.split("/")[1];
			var ano  = dateStr.split("/")[2];

			return `${ano}-${mes}-${dia}`;
		}
		
		function voltarParaListagem() {
			// Redirecionar para "./index.html"
			window.location.href = "./listagem_projetos.html";
		}
		
		function formularioValido(){
			var formValido = true;
			$("form input").each(function() {
				if ($(this).val().trim() === "" && $(this).prop("required")) {
					formValido =  false;
				}
			});
			
			$("form select").each(function() {
				if ((!$(this).val() ||  $(this).val() === "-1") && $(this).prop("required")) {
					formValido =  false;
				}
			});
			if(!formValido){
				alert("Por favor, preencha todos os campos obrigatórios.");
				destacarCamposRequeridosVazios();
			}
				
			return formValido;
		}
		
		function destacarCamposRequeridosVazios() {
			$("form :input[required]").each(function() {
				if (!$(this).val() || $(this).val().trim() === "") {
					$(this).addClass("required-field");
				}
			});
			
			$("form select").each(function() {
				if ((!$(this).val() ||  $(this).val().trim() === "-1") && $(this).prop("required")) {
					if (this.id == 'equipe') // Tratamento especial para select2
						 $('#equipe').next(".select2-container").addClass("required-field");
					else
						$(this).addClass("required-field");
				}
			});

			$(".required-field").on("change", function() {
				if ($(this).val() && $(this).val().trim() != "") {
					if (this.id == 'equipe') // Tratamento especial para select2
						 $('#equipe').next(".select2-container").removeClass("required-field");
					else
						$(this).removeClass("required-field");
				}
			});
		}
		
		function desabilitarAtividadesAdicionadas() {
			// Ocultar ou desabilitar as opções já adicionadas à tabela de atividades
			var atividadeSelect = $('#atividade');
			var atividadesAdicionadas = $('#tabelaAtividades tbody tr').map(function() {
				return $(this).find('.valorAtividade').text();
			}).get();

			atividadesAdicionadas.forEach(function(atividadeId) {
				atividadeSelect.find('option[value="' + atividadeId + '"]').prop('disabled', true);
			});

			atividadeSelect.trigger('change'); 
		}
		
		function validateToken() {
			token = localStorage.getItem("jwtToken")
			if (token) {
				return true;
			}
			else{
				window.location.href = baseUrl + "home";
				return false;
			}

		}
		
		function configurarAutocompleteAssuntos() {
			// Configurar autocomplete para o campo de assuntos
			$("#assuntoInput").autocomplete({
				source: function(request, response) {
					var term = request.term.toLowerCase();
					var matches = assuntosExistentes.filter(function(assunto) {
						return assunto.descricao.toLowerCase().indexOf(term) !== -1;
					});
					response(matches.map(function(assunto) {
						return {
							label: assunto.descricao,
							value: assunto.descricao,
							id: assunto.id
						};
					}));
				},
				minLength: 1,
				select: function(event, ui) {
					adicionarAssunto(ui.item.id, ui.item.value);
					return false;
				}
			});
			
			// Adicionar evento para adicionar assunto ao pressionar Enter
			$("#assuntoInput").keypress(function(e) {
				if (e.which == 13) { // Enter key
					e.preventDefault();
					var valor = $(this).val().trim();
					if (valor) {
						// Verificar se o assunto já existe no sistema
						var assuntoExistente = assuntosExistentes.find(function(a) {
							return a.descricao.toLowerCase() === valor.toLowerCase();
						});
						
						if (assuntoExistente) {
							adicionarAssunto(assuntoExistente.id, assuntoExistente.descricao);
						} else {
							// Se não existir, criar um novo objeto de assunto
							adicionarAssunto(null, valor);
						}
						
						$(this).val('');
					}
				}
			});
			
			// Adicionar evento para o botão de adicionar assunto
			$("#btnAdicionarAssunto").click(function() {
				var valor = $("#assuntoInput").val().trim();
				if (valor) {
					// Verificar se o assunto já existe no sistema
					var assuntoExistente = assuntosExistentes.find(function(a) {
						return a.descricao.toLowerCase() === valor.toLowerCase();
					});
					
					if (assuntoExistente) {
						adicionarAssunto(assuntoExistente.id, assuntoExistente.descricao);
					} else {
						// Se não existir, criar um novo objeto de assunto
						adicionarAssunto(null, valor);
					}
					
					$("#assuntoInput").val('');
				}
			});
		}
		
		function adicionarAssunto(id, descricao) {
			// Remover espaços extras, mas manter a capitalização original
			var descricaoFormatada = descricao.replace(/\s+/g, ' ').trim();
			
			// Verificar se o assunto já foi adicionado (ignorando maiúsculas/minúsculas)
			if (assuntosProjeto.some(a => a.descricao.toLowerCase() === descricaoFormatada.toLowerCase())) {
				alert("Este assunto já foi adicionado ao projeto.");
				return;
			}
			
			// Criar objeto de assunto
			var novoAssunto = {
				id: id || -1, // Usar -1 para novos assuntos ao invés de null
				descricao: descricaoFormatada
			};
			
			// Adicionar à lista de assuntos do projeto
			assuntosProjeto.push(novoAssunto);
			
			// Adicionar visualmente como tag
			var tagHtml = '<span class="assunto-tag" data-assunto-id="' + (id || -1) + '">' + 
				descricaoFormatada + 
				'<span class="remove-assunto" data-assunto-id="' + (id || -1) + '"><i class="fa fa-times"></i></span>' +
				'</span>';
			
			$("#assuntosContainer").append(tagHtml);
			
			// Adicionar evento para remover o assunto
			$(".remove-assunto").off("click").on("click", function() {
				var assuntoId = $(this).data("assunto-id");
				removerAssunto(assuntoId);
			});

			// Limpar o campo de input após adicionar o assunto
			$("#assuntoInput").val('');
		}
		
		function removerAssunto(assuntoId) {
			// Remover da lista de assuntos
			assuntosProjeto = assuntosProjeto.filter(function(a) {
				return a.id !== assuntoId && a.id !== -1;
			});
			
			// Remover visualmente
			$(".assunto-tag").each(function() {
				if ($(this).data("assunto-id") === assuntoId) {
					$(this).remove();
				}
			});
		}

    </script>
</body>
</html>
